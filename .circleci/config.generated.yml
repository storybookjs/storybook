version: 2.1
orbs:
    browser-tools: circleci/browser-tools@2.3.2
    codecov: codecov/codecov@5.4.3
    discord: antonioned/discord@0.1.0
    git-shallow-clone: guitarrapc/git-shallow-clone@2.8.0
    node: circleci/node@7.2.1
    nx: nrwl/nx@1.7.0
    win: circleci/windows@5.1.1
commands:
    cancel-workflow-on-failure:
        description: Cancels the entire workflow in case the previous step has failed
        steps:
            - run:
                  command: |
                      echo "Canceling workflow as previous step resulted in failure."
                      echo "To execute all checks locally, please run yarn ci-tests"
                      curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/cancel?circle-token=${WORKFLOW_CANCELER}"
                  name: Cancel current workflow
                  when: on_fail
    report-workflow-on-failure:
        description: Reports failures to discord
        parameters:
            template:
                default: none
                description: |
                    Which template to report in discord. Applicable for parallel sandbox jobs
                type: string
        steps:
            - run:
                  command: git fetch --unshallow
                  when: on_fail
            - discord/status:
                  fail_only: true
                  failure_message: $(yarn get-report-message << pipeline.parameters.workflow >> << parameters.template >>)
                  only_for_branches: main,next,next-release,latest-release
    start-event-collector:
        description: Starts the event collector
        steps:
            - run:
                  background: true
                  command: yarn jiti ./event-log-collector.ts
                  name: Start Event Collector
                  working_directory: scripts
executors:
    sb_node_18_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:18.20.3-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/project
    sb_node_22_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/project
    sb_node_22_classic:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/project
    sb_playwright:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: mcr.microsoft.com/playwright:v1.52.0-noble
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/project
parameters:
    ghBaseBranch:
        default: next
        description: The name of the base branch (the target of the PR)
        type: string
    ghPrNumber:
        default: ""
        description: The PR number
        type: string
    workflow:
        default: skipped
        description: Which workflow to run
        enum:
            - normal
            - merged
            - daily
            - skipped
            - docs
        type: enum
jobs:
    build-linux:
        description: build-linux
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: .
                  pkg-manager: yarn
                  cache-only-lockfile: true
            - save_cache:
                  paths:
                      - .yarn/cache
                      - .yarn/unplugged
                      - .yarn/build-state.yml
                      - .yarn/root-install-state.gz
                      - node_modules
                      - code/node_modules
                      - scripts/node_modules
                  key: v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
            - run:
                  name: Ensure no changes pending
                  command: git diff --exit-code
            - run:
                  name: Check for dedupe
                  command: yarn dedupe --check
            - run:
                  command: yarn task --task compile --start-from=auto --no-link --debug
                  name: Compile
                  working_directory: code
            - run:
                  command: yarn local-registry --publish
                  name: Publish to Verdaccio
                  working_directory: code
            - report-workflow-on-failure
            - store_artifacts:
                  path: code/bench/esbuild-metafiles
                  destination: bench
            - persist_to_workspace:
                  paths:
                      - project/code/core/dist
                      - project/code/core/node_modules
                      - project/code/addons/a11y/dist
                      - project/code/addons/a11y/node_modules
                      - project/code/addons/docs/dist
                      - project/code/addons/docs/node_modules
                      - project/code/addons/links/dist
                      - project/code/addons/links/node_modules
                      - project/code/addons/onboarding/dist
                      - project/code/addons/onboarding/node_modules
                      - project/code/addons/pseudo-states/dist
                      - project/code/addons/pseudo-states/node_modules
                      - project/code/addons/themes/dist
                      - project/code/addons/themes/node_modules
                      - project/code/addons/vitest/dist
                      - project/code/addons/vitest/node_modules
                      - project/code/builders/builder-vite/dist
                      - project/code/builders/builder-vite/node_modules
                      - project/code/builders/builder-webpack5/dist
                      - project/code/builders/builder-webpack5/node_modules
                      - project/code/frameworks/angular/dist
                      - project/code/frameworks/angular/node_modules
                      - project/code/frameworks/ember/dist
                      - project/code/frameworks/ember/node_modules
                      - project/code/frameworks/html-vite/dist
                      - project/code/frameworks/html-vite/node_modules
                      - project/code/frameworks/nextjs/dist
                      - project/code/frameworks/nextjs/node_modules
                      - project/code/frameworks/nextjs-vite/dist
                      - project/code/frameworks/nextjs-vite/node_modules
                      - project/code/frameworks/preact-vite/dist
                      - project/code/frameworks/preact-vite/node_modules
                      - project/code/frameworks/react-native-web-vite/dist
                      - project/code/frameworks/react-native-web-vite/node_modules
                      - project/code/frameworks/react-vite/dist
                      - project/code/frameworks/react-vite/node_modules
                      - project/code/frameworks/react-webpack5/dist
                      - project/code/frameworks/react-webpack5/node_modules
                      - project/code/frameworks/server-webpack5/dist
                      - project/code/frameworks/server-webpack5/node_modules
                      - project/code/frameworks/svelte-vite/dist
                      - project/code/frameworks/svelte-vite/node_modules
                      - project/code/frameworks/sveltekit/dist
                      - project/code/frameworks/sveltekit/node_modules
                      - project/code/frameworks/vue3-vite/dist
                      - project/code/frameworks/vue3-vite/node_modules
                      - project/code/frameworks/web-components-vite/dist
                      - project/code/frameworks/web-components-vite/node_modules
                      - project/code/lib/cli-storybook/dist
                      - project/code/lib/cli-storybook/node_modules
                      - project/code/lib/codemod/dist
                      - project/code/lib/codemod/node_modules
                      - project/code/lib/core-webpack/dist
                      - project/code/lib/core-webpack/node_modules
                      - project/code/lib/create-storybook/dist
                      - project/code/lib/create-storybook/node_modules
                      - project/code/lib/csf-plugin/dist
                      - project/code/lib/csf-plugin/node_modules
                      - project/code/lib/eslint-plugin/dist
                      - project/code/lib/eslint-plugin/node_modules
                      - project/code/lib/react-dom-shim/dist
                      - project/code/lib/react-dom-shim/node_modules
                      - project/code/presets/create-react-app/dist
                      - project/code/presets/create-react-app/node_modules
                      - project/code/presets/react-webpack/dist
                      - project/code/presets/react-webpack/node_modules
                      - project/code/presets/server-webpack/dist
                      - project/code/presets/server-webpack/node_modules
                      - project/code/renderers/html/dist
                      - project/code/renderers/html/node_modules
                      - project/code/renderers/preact/dist
                      - project/code/renderers/preact/node_modules
                      - project/code/renderers/react/dist
                      - project/code/renderers/react/node_modules
                      - project/code/renderers/server/dist
                      - project/code/renderers/server/node_modules
                      - project/code/renderers/svelte/dist
                      - project/code/renderers/svelte/node_modules
                      - project/code/renderers/vue3/dist
                      - project/code/renderers/vue3/node_modules
                      - project/code/renderers/web-components/dist
                      - project/code/renderers/web-components/node_modules
                      - project/.verdaccio-cache
                      - project/code/bench
                  root: /tmp
    build-windows:
        description: build-windows
        executor:
            name: win/default
            size: xlarge
            shell: bash.exe
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: '--depth 1 --config url."https://github.com/".insteadOf=ssh://git@github.com/ --config url."https://github.com/".insteadOf=git@github.com:'
            - run:
                  name: Install Node + Yarn
                  shell: powershell.exe
                  command: |-
                      $nodeVersion = Get-Content .nvmrc | Select-Object -First 1
                      nvm install $nodeVersion
                      nvm use $nodeVersion
                      corepack enable
                      corepack prepare yarn@stable --activate
            - node/install-packages:
                  app-dir: .
                  pkg-manager: yarn
                  cache-only-lockfile: true
            - run:
                  name: Compile
                  working_directory: code
                  command: yarn task --task compile --start-from=auto --no-link --debug
            - run:
                  name: Publish to Verdaccio
                  working_directory: code
                  command: yarn local-registry --publish
            - persist_to_workspace:
                  paths:
                      - code/core/dist
                      - code/core/node_modules
                      - code/addons/a11y/dist
                      - code/addons/a11y/node_modules
                      - code/addons/docs/dist
                      - code/addons/docs/node_modules
                      - code/addons/links/dist
                      - code/addons/links/node_modules
                      - code/addons/onboarding/dist
                      - code/addons/onboarding/node_modules
                      - code/addons/pseudo-states/dist
                      - code/addons/pseudo-states/node_modules
                      - code/addons/themes/dist
                      - code/addons/themes/node_modules
                      - code/addons/vitest/dist
                      - code/addons/vitest/node_modules
                      - code/builders/builder-vite/dist
                      - code/builders/builder-vite/node_modules
                      - code/builders/builder-webpack5/dist
                      - code/builders/builder-webpack5/node_modules
                      - code/frameworks/angular/dist
                      - code/frameworks/angular/node_modules
                      - code/frameworks/ember/dist
                      - code/frameworks/ember/node_modules
                      - code/frameworks/html-vite/dist
                      - code/frameworks/html-vite/node_modules
                      - code/frameworks/nextjs/dist
                      - code/frameworks/nextjs/node_modules
                      - code/frameworks/nextjs-vite/dist
                      - code/frameworks/nextjs-vite/node_modules
                      - code/frameworks/preact-vite/dist
                      - code/frameworks/preact-vite/node_modules
                      - code/frameworks/react-native-web-vite/dist
                      - code/frameworks/react-native-web-vite/node_modules
                      - code/frameworks/react-vite/dist
                      - code/frameworks/react-vite/node_modules
                      - code/frameworks/react-webpack5/dist
                      - code/frameworks/react-webpack5/node_modules
                      - code/frameworks/server-webpack5/dist
                      - code/frameworks/server-webpack5/node_modules
                      - code/frameworks/svelte-vite/dist
                      - code/frameworks/svelte-vite/node_modules
                      - code/frameworks/sveltekit/dist
                      - code/frameworks/sveltekit/node_modules
                      - code/frameworks/vue3-vite/dist
                      - code/frameworks/vue3-vite/node_modules
                      - code/frameworks/web-components-vite/dist
                      - code/frameworks/web-components-vite/node_modules
                      - code/lib/cli-storybook/dist
                      - code/lib/cli-storybook/node_modules
                      - code/lib/codemod/dist
                      - code/lib/codemod/node_modules
                      - code/lib/core-webpack/dist
                      - code/lib/core-webpack/node_modules
                      - code/lib/create-storybook/dist
                      - code/lib/create-storybook/node_modules
                      - code/lib/csf-plugin/dist
                      - code/lib/csf-plugin/node_modules
                      - code/lib/eslint-plugin/dist
                      - code/lib/eslint-plugin/node_modules
                      - code/lib/react-dom-shim/dist
                      - code/lib/react-dom-shim/node_modules
                      - code/presets/create-react-app/dist
                      - code/presets/create-react-app/node_modules
                      - code/presets/react-webpack/dist
                      - code/presets/react-webpack/node_modules
                      - code/presets/server-webpack/dist
                      - code/presets/server-webpack/node_modules
                      - code/renderers/html/dist
                      - code/renderers/html/node_modules
                      - code/renderers/preact/dist
                      - code/renderers/preact/node_modules
                      - code/renderers/react/dist
                      - code/renderers/react/node_modules
                      - code/renderers/server/dist
                      - code/renderers/server/node_modules
                      - code/renderers/svelte/dist
                      - code/renderers/svelte/node_modules
                      - code/renderers/vue3/dist
                      - code/renderers/vue3/node_modules
                      - code/renderers/web-components/dist
                      - code/renderers/web-components/node_modules
                      - .verdaccio-cache
                      - code/bench
                  root: C:\Users\circleci\project
    check:
        description: check
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: TypeCheck code
                  working_directory: code
                  command: yarn task --task check --no-link
            - run:
                  name: TypeCheck scripts
                  working_directory: scripts
                  command: yarn check
            - report-workflow-on-failure
            - cancel-workflow-on-failure
    init-empty:
        type: no-op
    init-empty-lit-vite-ts:
        description: init-empty-lit-vite-ts
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Linux NPM)
                  working_directory: /tmp
                  command: |-
                      mkdir empty-lit-vite-ts
                      cd empty-lit-vite-ts
                      npm set registry http://localhost:6001
                      npx storybook init --yes --package-manager npm
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: lit-vite-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: /tmp/empty-lit-vite-ts
                  command: npm run storybook -- --smoke-test
    init-empty-nextjs-ts:
        description: init-empty-nextjs-ts
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Linux NPM)
                  working_directory: /tmp
                  command: |-
                      mkdir empty-nextjs-ts
                      cd empty-nextjs-ts
                      npm set registry http://localhost:6001
                      npx storybook init --yes --package-manager npm
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: nextjs-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: /tmp/empty-nextjs-ts
                  command: npm run storybook -- --smoke-test
    init-empty-react-vite-ts:
        description: init-empty-react-vite-ts
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Linux NPM)
                  working_directory: /tmp
                  command: |-
                      mkdir empty-react-vite-ts
                      cd empty-react-vite-ts
                      npm set registry http://localhost:6001
                      npx storybook init --yes --package-manager npm
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: react-vite-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: /tmp/empty-react-vite-ts
                  command: npm run storybook -- --smoke-test
    init-empty-vue-vite-ts:
        description: init-empty-vue-vite-ts
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Linux NPM)
                  working_directory: /tmp
                  command: |-
                      mkdir empty-vue-vite-ts
                      cd empty-vue-vite-ts
                      npm set registry http://localhost:6001
                      npx storybook init --yes --package-manager npm
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: vue-vite-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: /tmp/empty-vue-vite-ts
                  command: npm run storybook -- --smoke-test
    init-empty-windows:
        description: init-empty-windows
        executor:
            name: win/default
            size: medium
            shell: bash.exe
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: '--depth 1 --config url."https://github.com/".insteadOf=ssh://git@github.com/ --config url."https://github.com/".insteadOf=git@github.com:'
            - run:
                  name: Install Node + Yarn
                  shell: powershell.exe
                  command: |-
                      $nodeVersion = Get-Content .nvmrc | Select-Object -First 1
                      nvm install $nodeVersion
                      nvm use $nodeVersion
                      corepack enable
                      corepack prepare yarn@stable --activate
            - attach_workspace:
                  at: C:\Users\circleci
            - run:
                  name: Install dependencies
                  command: yarn install
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Windows NPM)
                  working_directory: C:\Users\circleci
                  command: |-
                      mkdir empty-react-vite-ts
                      cd empty-react-vite-ts
                      npm set registry http://localhost:6001
                      npx storybook init --yes --package-manager npm
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: react-vite-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: C:\Users\circleci\empty-react-vite-ts
                  command: npm run storybook -- --smoke-test
    init-features:
        description: init-features
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Storybook init from empty directory (Linux NPM)
                  working_directory: /tmp
                  command: |-
                      mkdir empty-react-vite-ts
                      cd empty-react-vite-ts
                      npm set registry http://localhost:6001
                      npx create-storybook --yes --package-manager npm --features docs test a11y --loglevel=debug
                  environment:
                      IN_STORYBOOK_SANDBOX: true
                      STORYBOOK_DISABLE_TELEMETRY: true
                      STORYBOOK_INIT_EMPTY_TYPE: react-vite-ts
            - run:
                  name: Run storybook smoke test
                  working_directory: /tmp/empty-react-vite-ts
                  command: npx vitest
    knip:
        description: knip
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Run Knip
                  working_directory: code
                  command: yarn knip --no-exit-code
    package-benchmarks:
        description: package-benchmarks
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Benchmarking packages against base branch
                  command: yarn bench-packages --base-branch << pipeline.parameters.ghBaseBranch >> --pull-request << pipeline.parameters.ghPrNumber >> --upload
                  working_directory: scripts
    pretty-docs:
        executor:
            name: sb_node_22_classic
            class: medium+
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: .
                  pkg-manager: yarn
                  cache-only-lockfile: true
            - run:
                  name: Prettier
                  working_directory: scripts
                  command: yarn docs:prettier:check
    react-vite-default-ts--build:
        description: react-vite/default-ts (build)
        executor:
            name: sb_playwright
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Build storybook
                  command: yarn task build --template react-vite/default-ts --no-link -s build
            - persist_to_workspace:
                  paths:
                      - storybook-sandboxes/react-vite-default-ts/storybook-static
                  root: /tmp
            - run:
                  name: Serve storybook
                  background: true
                  command: yarn task serve --template react-vite/default-ts --no-link -s serve
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests --template react-vite/default-ts --no-link -s e2e-tests" --verbose --index=0 --total=1
    react-vite-default-ts--build-test-runner:
        description: react-vite-default-ts--build-test-runner
        executor:
            name: sb_playwright
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Running test-runner
                  command: yarn task test-runner --template react-vite/default-ts --no-link -s test-runner
    react-vite-default-ts--build-windows:
        description: react-vite-default-ts--build-windows
        executor:
            name: win/default
            size: xlarge
            shell: bash.exe
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: '--depth 1 --config url."https://github.com/".insteadOf=ssh://git@github.com/ --config url."https://github.com/".insteadOf=git@github.com:'
            - run:
                  name: Install Node + Yarn
                  shell: powershell.exe
                  command: |-
                      $nodeVersion = Get-Content .nvmrc | Select-Object -First 1
                      nvm install $nodeVersion
                      nvm use $nodeVersion
                      corepack enable
                      corepack prepare yarn@stable --activate
            - attach_workspace:
                  at: C:\Users\circleci
            - run:
                  name: Install dependencies
                  command: yarn install
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Run Install
                  working_directory: C:\Users\circleci\storybook-sandboxes\react-vite-default-ts
                  command: yarn install
            - run:
                  name: Install playwright
                  command: yarn playwright install chromium --with-deps
            - run:
                  name: Build storybook
                  command: yarn task build --template react-vite/default-ts --no-link -s build
            - run:
                  name: Serve storybook
                  background: true
                  command: yarn task serve --template react-vite/default-ts --no-link -s serve
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  working_directory: code
                  command: yarn task e2e-tests --template react-vite/default-ts --no-link -s e2e-tests
    react-vite-default-ts--chromatic:
        description: react-vite/default-ts (chromatic)
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - checkout
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Copy sandbox to working directory
                  command: cp /tmp/storybook-sandboxes /tmp/project/sandbox -r --remove-destination
            - run:
                  name: Running Chromatic
                  command: yarn task chromatic --template react-vite/default-ts --no-link -s chromatic
                  environment:
                      STORYBOOK_SANDBOX_ROOT: ./sandbox
    react-vite-default-ts--create:
        description: react-vite/default-ts (create)
        executor:
            name: sb_node_22_browsers
            class: large
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Start Event Collector
                  working_directory: scripts
                  background: true
                  command: yarn jiti ./event-log-collector.ts
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
                      yarn wait-on tcp:127.0.0.1:6007
            - run:
                  name: Setup Corepack
                  command: |-
                      sudo corepack enable
                      which yarn
                      yarn --version
            - run:
                  name: Create Sandboxes
                  command: yarn task sandbox --template react-vite/default-ts --no-link -s sandbox --debug
                  environment:
                      STORYBOOK_TELEMETRY_DEBUG: 1
                      STORYBOOK_TELEMETRY_URL: http://127.0.0.1:6007/event-log
            - store_artifacts:
                  path: /tmp/storybook-sandboxes/react-vite-default-ts/debug-storybook.log
                  destination: logs
            - persist_to_workspace:
                  paths:
                      - storybook-sandboxes/react-vite-default-ts
                  root: /tmp
    react-vite-default-ts--dev:
        description: react-vite/default-ts (dev)
        executor:
            name: sb_playwright
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Run storybook
                  working_directory: code
                  background: true
                  command: yarn task dev --template react-vite/default-ts --no-link -s dev
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:6006
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests-dev --template react-vite/default-ts --no-link -s e2e-tests-dev" --verbose --index=0 --total=1
    react-vite-default-ts--dev-windows:
        description: react-vite-default-ts--dev-windows
        executor:
            name: win/default
            size: xlarge
            shell: bash.exe
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: '--depth 1 --config url."https://github.com/".insteadOf=ssh://git@github.com/ --config url."https://github.com/".insteadOf=git@github.com:'
            - run:
                  name: Install Node + Yarn
                  shell: powershell.exe
                  command: |-
                      $nodeVersion = Get-Content .nvmrc | Select-Object -First 1
                      nvm install $nodeVersion
                      nvm use $nodeVersion
                      corepack enable
                      corepack prepare yarn@stable --activate
            - attach_workspace:
                  at: C:\Users\circleci
            - run:
                  name: Install dependencies
                  command: yarn install
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
            - run:
                  name: Run Install
                  working_directory: C:\Users\circleci\storybook-sandboxes\react-vite-default-ts
                  command: yarn install
            - run:
                  name: Install playwright
                  command: yarn playwright install chromium --with-deps
            - run:
                  name: Run storybook
                  background: true
                  working_directory: C:\Users\circleci\storybook-sandboxes\react-vite-default-ts
                  command: yarn storybook --port 8001
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  working_directory: code
                  command: yarn task e2e-tests-dev --template react-vite/default-ts --no-link -s e2e-tests-dev
    react-vite-default-ts--vitest:
        description: react-vite/default-ts (vitest)
        executor:
            name: sb_playwright
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Running Vitest
                  command: yarn task vitest-integration --template react-vite/default-ts --no-link -s vitest-integration
    sandboxes:
        type: no-op
    test-storybooks:
        type: no-op
    test-storybooks-pnp:
        description: test-storybooks-pnp
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Install dependencies
                  working_directory: test-storybooks/yarn-pnp
                  command: yarn install --no-immutable
                  environment:
                      YARN_ENABLE_IMMUTABLE_INSTALLS: false
            - run:
                  name: Run Storybook smoke test
                  working_directory: test-storybooks/yarn-pnp
                  command: yarn storybook --smoke-test
    test-storybooks-portable-react:
        description: test-storybooks-portable-react
        executor:
            name: sb_playwright
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Install dependencies
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn install --no-immutable
                  environment:
                      YARN_ENABLE_IMMUTABLE_INSTALLS: false
            - run:
                  name: Run Jest tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn jest
            - run:
                  name: Run Vitest tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn vitest
            - run:
                  name: Run Playwright CT tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn playwright-ct
            - run:
                  name: Run Playwright E2E tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn playwright-e2e
            - run:
                  name: Run Cypress CT tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react
                  command: yarn cypress
    test-storybooks-portable-vitest3:
        description: test-storybooks-portable-vitest3
        executor:
            name: sb_playwright
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Install dependencies
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react-vitest-3
                  command: yarn install --no-immutable
                  environment:
                      YARN_ENABLE_IMMUTABLE_INSTALLS: false
            - run:
                  name: Run Playwright E2E tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/react-vitest-3
                  command: yarn playwright-e2e
    test-storybooks-portable-vue3:
        description: test-storybooks-portable-vue3
        executor:
            name: sb_playwright
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Install dependencies
                  working_directory: test-storybooks/portable-stories-kitchen-sink/vue3
                  command: yarn install --no-immutable
                  environment:
                      YARN_ENABLE_IMMUTABLE_INSTALLS: false
            - run:
                  name: Run Jest tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/vue3
                  command: yarn jest
            - run:
                  name: Run Vitest tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/vue3
                  command: yarn vitest
            - run:
                  name: Run Playwright CT tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/vue3
                  command: yarn playwright-ct
            - run:
                  name: Run Cypress CT tests
                  working_directory: test-storybooks/portable-stories-kitchen-sink/vue3
                  command: yarn cypress
    ui:
        description: ui
        executor:
            name: sb_node_22_classic
            class: medium+
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Build internal storybook
                  command: yarn storybook:ui:build
                  working_directory: code
            - run:
                  name: Run Chromatic
                  command: yarn storybook:ui:chromatic
                  working_directory: code
            - report-workflow-on-failure
            - store_test_results:
                  path: test-results
    unit-tests-linux:
        description: unit-tests-linux
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys:
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - v5-linux-node_modules/{{ checksum ".nvmrc" }}
                      - v5-linux-node_modules
            - run:
                  name: Run tests
                  working_directory: code
                  command: |-
                      TEST_FILES=$(circleci tests glob "**/*.{test,spec}.{ts,tsx,js,jsx,cjs}" | sed "/^e2e-tests\//d" | sed "/^node_modules\//d")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn test --reporter=junit --reporter=default --outputFile=../test-results/junit-${CIRCLE_NODE_INDEX}.xml" --verbose
            - store_test_results:
                  path: project/test-results
            - run:
                  name: Ensure no changes pending
                  command: git diff --exit-code
            - report-workflow-on-failure
            - cancel-workflow-on-failure
    unit-tests-windows:
        description: unit-tests-windows
        executor:
            name: win/default
            size: medium
            shell: bash.exe
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: '--depth 1 --config url."https://github.com/".insteadOf=ssh://git@github.com/ --config url."https://github.com/".insteadOf=git@github.com:'
            - run:
                  name: Install Node + Yarn
                  shell: powershell.exe
                  command: |-
                      $nodeVersion = Get-Content .nvmrc | Select-Object -First 1
                      nvm install $nodeVersion
                      nvm use $nodeVersion
                      corepack enable
                      corepack prepare yarn@stable --activate
            - attach_workspace:
                  at: C:\Users\circleci
            - run:
                  name: Install dependencies
                  command: yarn install
            - run:
                  command: yarn install
                  name: Install dependencies
            - run:
                  command: yarn test
                  name: Run unit tests
                  working_directory: code
workflows:
    generated:
        jobs:
            - build-linux
            - build-windows
            - pretty-docs
            - check:
                  requires:
                      - build-linux
            - init-empty:
                  requires:
                      - build-linux
            - init-empty-lit-vite-ts:
                  requires:
                      - init-empty
            - init-empty-nextjs-ts:
                  requires:
                      - init-empty
            - init-empty-react-vite-ts:
                  requires:
                      - init-empty
            - init-empty-vue-vite-ts:
                  requires:
                      - init-empty
            - init-empty-windows:
                  requires:
                      - init-empty
            - init-features:
                  requires:
                      - init-empty
            - knip:
                  requires:
                      - build-linux
            - package-benchmarks:
                  requires:
                      - build-linux
            - react-vite-default-ts--build:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--build-test-runner:
                  requires:
                      - react-vite-default-ts--build
            - react-vite-default-ts--build-windows:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--chromatic:
                  requires:
                      - react-vite-default-ts--build
            - react-vite-default-ts--create:
                  requires:
                      - sandboxes
            - react-vite-default-ts--dev:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--dev-windows:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--vitest:
                  requires:
                      - react-vite-default-ts--build
            - sandboxes:
                  requires:
                      - build-linux
            - test-storybooks:
                  requires:
                      - build-linux
            - test-storybooks-pnp:
                  requires:
                      - test-storybooks
            - test-storybooks-portable-react:
                  requires:
                      - test-storybooks
            - test-storybooks-portable-vitest3:
                  requires:
                      - test-storybooks
            - test-storybooks-portable-vue3:
                  requires:
                      - test-storybooks
            - ui:
                  requires:
                      - build-linux
            - unit-tests-linux:
                  requires:
                      - build-linux
            - unit-tests-windows:
                  requires:
                      - build-windows
