version: 2.1
orbs:
    browser-tools: circleci/browser-tools@2.3.2
    codecov: codecov/codecov@5.4.3
    discord: antonioned/discord@0.1.0
    git-shallow-clone: guitarrapc/git-shallow-clone@2.8.0
    node: circleci/node@7.2.1
    nx: nrwl/nx@1.7.0
    win: circleci/windows@5.1.1
commands:
    cancel-workflow-on-failure:
        description: Cancels the entire workflow in case the previous step has failed
        steps:
            - run:
                  command: |
                      echo "Canceling workflow as previous step resulted in failure."
                      echo "To execute all checks locally, please run yarn ci-tests"
                      curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/cancel?circle-token=${WORKFLOW_CANCELER}"
                  name: Cancel current workflow
                  when: on_fail
    report-workflow-on-failure:
        description: Reports failures to discord
        parameters:
            template:
                default: none
                description: |
                    Which template to report in discord. Applicable for parallel sandbox jobs
                type: string
        steps:
            - run:
                  command: git fetch --unshallow
                  when: on_fail
            - discord/status:
                  fail_only: true
                  failure_message: $(yarn get-report-message << pipeline.parameters.workflow >> << parameters.template >>)
                  only_for_branches: main,next,next-release,latest-release
    start-event-collector:
        description: Starts the event collector
        steps:
            - run:
                  background: true
                  command: yarn jiti ./event-log-collector.ts
                  name: Start Event Collector
                  working_directory: scripts
executors:
    sb_node_18_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:18.20.3-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_node_22_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_node_22_classic:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_playwright:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: mcr.microsoft.com/playwright:v1.52.0-noble
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
parameters:
    ghBaseBranch:
        default: next
        description: The name of the base branch (the target of the PR)
        type: string
    ghPrNumber:
        default: ""
        description: The PR number
        type: string
    workflow:
        default: skipped
        description: Which workflow to run
        enum:
            - normal
            - merged
            - daily
            - skipped
            - docs
        type: enum
jobs:
    build:
        description: build
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: /tmp/storybook
                  pkg-manager: yarn
                  cache-only-lockfile: true
            - save_cache:
                  paths:
                      - .yarn/code-install-state.gz
                      - .yarn/scripts-install-state.gz
                      - .yarn/root-install-state.gz
                      - node_modules
                      - code/node_modules
                      - scripts/node_modules
                  key: darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
            - run:
                  name: Ensure no changes pending
                  command: git diff --exit-code
            - run:
                  name: Check for dedupe
                  command: yarn dedupe --check
            - run:
                  command: yarn task --task compile --start-from=auto --no-link --debug
                  name: Compile
                  working_directory: /tmp/storybook/code
            - run:
                  command: yarn local-registry --publish
                  name: Publish to Verdaccio
                  working_directory: /tmp/storybook/code
            - report-workflow-on-failure
            - store_artifacts:
                  path: /tmp/storybook/code/bench/esbuild-metafiles
                  destination: bench
            - persist_to_workspace:
                  paths:
                      - /tmp/storybook/code/core/dist
                      - /tmp/storybook/code/core/node_modules
                      - /tmp/storybook/code/addons/a11y/dist
                      - /tmp/storybook/code/addons/a11y/node_modules
                      - /tmp/storybook/code/addons/docs/dist
                      - /tmp/storybook/code/addons/docs/node_modules
                      - /tmp/storybook/code/addons/links/dist
                      - /tmp/storybook/code/addons/links/node_modules
                      - /tmp/storybook/code/addons/onboarding/dist
                      - /tmp/storybook/code/addons/onboarding/node_modules
                      - /tmp/storybook/code/addons/pseudo-states/dist
                      - /tmp/storybook/code/addons/pseudo-states/node_modules
                      - /tmp/storybook/code/addons/themes/dist
                      - /tmp/storybook/code/addons/themes/node_modules
                      - /tmp/storybook/code/addons/vitest/dist
                      - /tmp/storybook/code/addons/vitest/node_modules
                      - /tmp/storybook/code/builders/builder-vite/dist
                      - /tmp/storybook/code/builders/builder-vite/node_modules
                      - /tmp/storybook/code/builders/builder-webpack5/dist
                      - /tmp/storybook/code/builders/builder-webpack5/node_modules
                      - /tmp/storybook/code/frameworks/angular/dist
                      - /tmp/storybook/code/frameworks/angular/node_modules
                      - /tmp/storybook/code/frameworks/ember/dist
                      - /tmp/storybook/code/frameworks/ember/node_modules
                      - /tmp/storybook/code/frameworks/html-vite/dist
                      - /tmp/storybook/code/frameworks/html-vite/node_modules
                      - /tmp/storybook/code/frameworks/nextjs/dist
                      - /tmp/storybook/code/frameworks/nextjs/node_modules
                      - /tmp/storybook/code/frameworks/nextjs-vite/dist
                      - /tmp/storybook/code/frameworks/nextjs-vite/node_modules
                      - /tmp/storybook/code/frameworks/preact-vite/dist
                      - /tmp/storybook/code/frameworks/preact-vite/node_modules
                      - /tmp/storybook/code/frameworks/react-native-web-vite/dist
                      - /tmp/storybook/code/frameworks/react-native-web-vite/node_modules
                      - /tmp/storybook/code/frameworks/react-vite/dist
                      - /tmp/storybook/code/frameworks/react-vite/node_modules
                      - /tmp/storybook/code/frameworks/react-webpack5/dist
                      - /tmp/storybook/code/frameworks/react-webpack5/node_modules
                      - /tmp/storybook/code/frameworks/server-webpack5/dist
                      - /tmp/storybook/code/frameworks/server-webpack5/node_modules
                      - /tmp/storybook/code/frameworks/svelte-vite/dist
                      - /tmp/storybook/code/frameworks/svelte-vite/node_modules
                      - /tmp/storybook/code/frameworks/sveltekit/dist
                      - /tmp/storybook/code/frameworks/sveltekit/node_modules
                      - /tmp/storybook/code/frameworks/vue3-vite/dist
                      - /tmp/storybook/code/frameworks/vue3-vite/node_modules
                      - /tmp/storybook/code/frameworks/web-components-vite/dist
                      - /tmp/storybook/code/frameworks/web-components-vite/node_modules
                      - /tmp/storybook/code/lib/cli-storybook/dist
                      - /tmp/storybook/code/lib/cli-storybook/node_modules
                      - /tmp/storybook/code/lib/codemod/dist
                      - /tmp/storybook/code/lib/codemod/node_modules
                      - /tmp/storybook/code/lib/core-webpack/dist
                      - /tmp/storybook/code/lib/core-webpack/node_modules
                      - /tmp/storybook/code/lib/create-storybook/dist
                      - /tmp/storybook/code/lib/create-storybook/node_modules
                      - /tmp/storybook/code/lib/csf-plugin/dist
                      - /tmp/storybook/code/lib/csf-plugin/node_modules
                      - /tmp/storybook/code/lib/eslint-plugin/dist
                      - /tmp/storybook/code/lib/eslint-plugin/node_modules
                      - /tmp/storybook/code/lib/react-dom-shim/dist
                      - /tmp/storybook/code/lib/react-dom-shim/node_modules
                      - /tmp/storybook/code/presets/create-react-app/dist
                      - /tmp/storybook/code/presets/create-react-app/node_modules
                      - /tmp/storybook/code/presets/react-webpack/dist
                      - /tmp/storybook/code/presets/react-webpack/node_modules
                      - /tmp/storybook/code/presets/server-webpack/dist
                      - /tmp/storybook/code/presets/server-webpack/node_modules
                      - /tmp/storybook/code/renderers/html/dist
                      - /tmp/storybook/code/renderers/html/node_modules
                      - /tmp/storybook/code/renderers/preact/dist
                      - /tmp/storybook/code/renderers/preact/node_modules
                      - /tmp/storybook/code/renderers/react/dist
                      - /tmp/storybook/code/renderers/react/node_modules
                      - /tmp/storybook/code/renderers/server/dist
                      - /tmp/storybook/code/renderers/server/node_modules
                      - /tmp/storybook/code/renderers/svelte/dist
                      - /tmp/storybook/code/renderers/svelte/node_modules
                      - /tmp/storybook/code/renderers/vue3/dist
                      - /tmp/storybook/code/renderers/vue3/node_modules
                      - /tmp/storybook/code/renderers/web-components/dist
                      - /tmp/storybook/code/renderers/web-components/node_modules
                      - /tmp/storybook/.verdaccio-cache
                  root: /tmp
    check:
        description: check
        executor:
            class: xlarge
            name: sb_node_22_classic
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys: &a1
                      - darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "yarn.lock" }}
                      - darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - darwin-node_modules/{{ checksum ".nvmrc" }}
                      - darwin-node_modules
            - run:
                  name: TypeCheck code
                  working_directory: /tmp/storybook/code
                  command: yarn task --task check --no-link
            - run:
                  name: TypeCheck scripts
                  working_directory: /tmp/storybook/scripts
                  command: yarn check
            - run:
                  name: Ensure no changes pending
                  command: git diff --exit-code
            - report-workflow-on-failure
            - cancel-workflow-on-failure
    unit-tests:
        description: unit-tests
        executor:
            name: sb_node_22_classic
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys: *a1
            - run:
                  name: Run tests
                  working_directory: /tmp/storybook/code
                  command: |-
                      TEST_FILES=$(circleci tests glob "**/*.{test,spec}.{ts,tsx,js,jsx,cjs}" | sed "/^e2e-tests\//d" | sed "/^node_modules\//d")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn test --reporter=junit --reporter=default --outputFile=../test-results/junit-${CIRCLE_NODE_INDEX}.xml" --verbose
            - store_test_results:
                  path: /tmp/storybook/test-results
            - run:
                  name: Ensure no changes pending
                  command: git diff --exit-code
            - report-workflow-on-failure
            - cancel-workflow-on-failure
    pretty-docs:
        executor:
            name: sb_node_22_classic
            class: medium
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: /tmp/storybook
                  pkg-manager: yarn
                  cache-only-lockfile: true
            - run:
                  name: Prettier
                  working_directory: /tmp/storybook/scripts
                  command: yarn docs:prettier:check
    sandboxes:
        type: no-op
    react-vite-default-ts--create:
        description: react-vite/default-ts (create)
        executor:
            name: sb_node_22_browsers
            class: large
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys: *a1
            - run:
                  name: Verdaccio
                  working_directory: /tmp/storybook/code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Start Event Collector
                  working_directory: /tmp/storybook/scripts
                  background: true
                  command: yarn jiti ./event-log-collector.ts
            - run:
                  name: Wait on servers
                  working_directory: /tmp/storybook/code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
                      yarn wait-on tcp:127.0.0.1:6007
            - run:
                  name: Setup Corepack
                  command: |-
                      sudo corepack enable
                      which yarn
                      yarn --version
            - run:
                  name: Create Sandboxes
                  command: yarn task sandbox --template react-vite/default-ts --no-link -s sandbox --debug
                  environment:
                      STORYBOOK_TELEMETRY_DEBUG: 1
                      STORYBOOK_TELEMETRY_URL: http://127.0.0.1:6007/event-log
            - store_artifacts:
                  path: /tmp/storybook-sandboxes/react-vite-default-ts/debug-storybook.log
                  destination: logs
            - persist_to_workspace:
                  paths:
                      - /tmp/storybook-sandboxes/react-vite-default-ts
                  root: /tmp
    react-vite-default-ts--build:
        description: react-vite/default-ts (build)
        executor:
            name: sb_playwright
            class: xlarge
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys: *a1
            - run:
                  name: Build storybook
                  command: yarn task build --template react-vite/default-ts --no-link -s build
            - run:
                  name: Serve storybook
                  background: true
                  command: yarn task serve --template react-vite/default-ts --no-link -s serve
            - run:
                  name: Wait on storybook
                  working_directory: /tmp/storybook/code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "/tmp/storybook/code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests --template react-vite/default-ts --no-link -s never" --verbose --index=0 --total=1
    react-vite-default-ts--dev:
        description: react-vite/default-ts (dev)
        executor:
            class: xlarge
            name: sb_playwright
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: /tmp
            - restore_cache:
                  keys: *a1
            - run:
                  name: Run storybook
                  working_directory: code
                  background: true
                  command: yarn task dev --template react-vite/default-ts --no-link -s dev
            - run:
                  name: Wait on storybook
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:6006
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests-dev --template react-vite/default-ts --no-link -s never" --verbose --index=0 --total=1
workflows:
    docs:
        jobs:
            - pretty-docs
            - build
            - check:
                  requires:
                      - build
            - unit-tests:
                  requires:
                      - build
            - sandboxes:
                  requires:
                      - build
            - react-vite-default-ts--create:
                  requires:
                      - sandboxes
            - react-vite-default-ts--build:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--dev:
                  requires:
                      - react-vite-default-ts--create
        when:
            equal:
                - docs
                - << pipeline.parameters.workflow >>
