version: 2.1
orbs:
    browser-tools: circleci/browser-tools@2.3.2
    codecov: codecov/codecov@5.4.3
    discord: antonioned/discord@0.1.0
    git-shallow-clone: guitarrapc/git-shallow-clone@2.8.0
    node: circleci/node@7.2.1
    nx: nrwl/nx@1.7.0
    win: circleci/windows@5.1.1
commands:
    cancel-workflow-on-failure:
        description: Cancels the entire workflow in case the previous step has failed
        steps:
            - run:
                  command: |
                      echo "Canceling workflow as previous step resulted in failure."
                      echo "To execute all checks locally, please run yarn ci-tests"
                      curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/cancel?circle-token=${WORKFLOW_CANCELER}"
                  name: Cancel current workflow
                  when: on_fail
    report-workflow-on-failure:
        description: Reports failures to discord
        parameters:
            template:
                default: none
                description: |
                    Which template to report in discord. Applicable for parallel sandbox jobs
                type: string
        steps:
            - run:
                  command: git fetch --unshallow
                  when: on_fail
            - discord/status:
                  fail_only: true
                  failure_message: $(yarn get-report-message << pipeline.parameters.workflow >> << parameters.template >>)
                  only_for_branches: main,next,next-release,latest-release
    start-event-collector:
        description: Starts the event collector
        steps:
            - run:
                  background: true
                  command: yarn jiti ./event-log-collector.ts
                  name: Start Event Collector
                  working_directory: scripts
executors:
    sb_node_18_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:18.20.3-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_node_22_browsers:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0-browsers
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_node_22_classic:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: cimg/node:22.15.0
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
    sb_playwright:
        docker:
            - environment:
                  NODE_OPTIONS: --max_old_space_size=6144
              image: mcr.microsoft.com/playwright:v1.52.0-noble
        parameters:
            class:
                default: small
                description: The Resource class
                enum:
                    - small
                    - medium
                    - medium+
                    - large
                    - xlarge
                type: enum
        resource_class: <<parameters.class>>
        working_directory: /tmp/storybook
parameters:
    ghBaseBranch:
        default: next
        description: The name of the base branch (the target of the PR)
        type: string
    ghPrNumber:
        default: ""
        description: The PR number
        type: string
    workflow:
        default: skipped
        description: Which workflow to run
        enum:
            - normal
            - merged
            - daily
            - skipped
            - docs
        type: enum
jobs:
    build:
        description: build
        executor:
            class: xlarge
            name: sb_node_22_classic
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: code
                  cache-only-lockfile: true
                  pkg-manager: yarn
            - node/install-packages:
                  app-dir: scripts
                  cache-only-lockfile: true
                  pkg-manager: yarn
            - save_cache:
                  paths:
                      - .yarn/code-install-state.gz
                      - .yarn/scripts-install-state.gz
                      - .yarn/root-install-state.gz
                      - code/node_modules
                      - scripts/node_modules
                  key: darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "scripts/yarn.lock" }}/{{ checksum "code/yarn.lock" }}
            - run:
                  command: git diff --exit-code
                  name: Check for changes
            - run:
                  command: yarn dedupe --check
                  name: Check for dedupe
            - run:
                  command: yarn task --task compile --start-from=auto --no-link --debug
                  name: Compile
                  working_directory: code
            - run:
                  command: yarn local-registry --publish
                  name: Publish to Verdaccio
                  working_directory: code
            - report-workflow-on-failure
            - store_artifacts:
                  path: code/bench/esbuild-metafiles
            - persist_to_workspace:
                  paths:
                      - code/core/dist
                      - code/core/node_modules
                      - code/addons/a11y/dist
                      - code/addons/a11y/node_modules
                      - code/addons/docs/dist
                      - code/addons/docs/node_modules
                      - code/addons/links/dist
                      - code/addons/links/node_modules
                      - code/addons/onboarding/dist
                      - code/addons/onboarding/node_modules
                      - code/addons/pseudo-states/dist
                      - code/addons/pseudo-states/node_modules
                      - code/addons/themes/dist
                      - code/addons/themes/node_modules
                      - code/addons/vitest/dist
                      - code/addons/vitest/node_modules
                      - code/builders/builder-vite/dist
                      - code/builders/builder-vite/node_modules
                      - code/builders/builder-webpack5/dist
                      - code/builders/builder-webpack5/node_modules
                      - code/frameworks/angular/dist
                      - code/frameworks/angular/node_modules
                      - code/frameworks/ember/dist
                      - code/frameworks/ember/node_modules
                      - code/frameworks/html-vite/dist
                      - code/frameworks/html-vite/node_modules
                      - code/frameworks/nextjs/dist
                      - code/frameworks/nextjs/node_modules
                      - code/frameworks/nextjs-vite/dist
                      - code/frameworks/nextjs-vite/node_modules
                      - code/frameworks/preact-vite/dist
                      - code/frameworks/preact-vite/node_modules
                      - code/frameworks/react-native-web-vite/dist
                      - code/frameworks/react-native-web-vite/node_modules
                      - code/frameworks/react-vite/dist
                      - code/frameworks/react-vite/node_modules
                      - code/frameworks/react-webpack5/dist
                      - code/frameworks/react-webpack5/node_modules
                      - code/frameworks/server-webpack5/dist
                      - code/frameworks/server-webpack5/node_modules
                      - code/frameworks/svelte-vite/dist
                      - code/frameworks/svelte-vite/node_modules
                      - code/frameworks/sveltekit/dist
                      - code/frameworks/sveltekit/node_modules
                      - code/frameworks/vue3-vite/dist
                      - code/frameworks/vue3-vite/node_modules
                      - code/frameworks/web-components-vite/dist
                      - code/frameworks/web-components-vite/node_modules
                      - code/lib/cli-storybook/dist
                      - code/lib/cli-storybook/node_modules
                      - code/lib/codemod/dist
                      - code/lib/codemod/node_modules
                      - code/lib/core-webpack/dist
                      - code/lib/core-webpack/node_modules
                      - code/lib/create-storybook/dist
                      - code/lib/create-storybook/node_modules
                      - code/lib/csf-plugin/dist
                      - code/lib/csf-plugin/node_modules
                      - code/lib/eslint-plugin/dist
                      - code/lib/eslint-plugin/node_modules
                      - code/lib/react-dom-shim/dist
                      - code/lib/react-dom-shim/node_modules
                      - code/presets/create-react-app/dist
                      - code/presets/create-react-app/node_modules
                      - code/presets/react-webpack/dist
                      - code/presets/react-webpack/node_modules
                      - code/presets/server-webpack/dist
                      - code/presets/server-webpack/node_modules
                      - code/renderers/html/dist
                      - code/renderers/html/node_modules
                      - code/renderers/preact/dist
                      - code/renderers/preact/node_modules
                      - code/renderers/react/dist
                      - code/renderers/react/node_modules
                      - code/renderers/server/dist
                      - code/renderers/server/node_modules
                      - code/renderers/svelte/dist
                      - code/renderers/svelte/node_modules
                      - code/renderers/vue3/dist
                      - code/renderers/vue3/node_modules
                      - code/renderers/web-components/dist
                      - code/renderers/web-components/node_modules
                      - code/core/node_modules/human-signals/build/dist
                      - code/core/node_modules/human-signals/build/node_modules
                      - code/core/dist/core-server/utils/__mockdata__/src
                      - code/core/node_modules/core-server/utils/__mockdata__/src
                      - code/core/dist/core-server/utils/__search-files-tests__/src
                      - code/core/node_modules/core-server/utils/__search-files-tests__/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/minimal-config/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/minimal-config/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/some-config/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/some-config/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/with-angularBrowserTarget/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/with-angularBrowserTarget/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/with-nx/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/with-nx/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/with-nx-workspace/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/with-nx-workspace/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/with-options-styles/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/with-options-styles/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/without-tsConfig/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/without-tsConfig/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/with-lib/projects/pattern-lib/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/with-lib/projects/pattern-lib/src
                      - code/frameworks/angular/dist/server/__mocks-ng-workspace__/without-projects-entry/projects/pattern-lib/src
                      - code/frameworks/angular/node_modules/server/__mocks-ng-workspace__/without-projects-entry/projects/pattern-lib/src
                      - .verdaccio-cache
                  root: .
    check:
        executor:
            class: xlarge
            name: sb_node_22_classic
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: &a1
                      - darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "scripts/yarn.lock" }}/{{ checksum "code/yarn.lock" }}
                      - darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}/{{ checksum "scripts/yarn.lock" }}
                      - darwin-node_modules/{{ checksum ".nvmrc" }}/{{ checksum ".yarnrc.yml" }}
                      - darwin-node_modules/{{ checksum ".nvmrc" }}
                      - darwin-node_modules
            - run:
                  command: yarn task --task check --no-link
                  name: TypeCheck code
                  working_directory: code
            - run:
                  command: yarn check
                  name: TypeCheck scripts
                  working_directory: scripts
            - run:
                  command: git diff --exit-code
                  name: Ensure no changes pending
            - report-workflow-on-failure
            - cancel-workflow-on-failure
    pretty-docs:
        executor:
            class: medium
            name: sb_node_22_classic
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - node/install-packages:
                  app-dir: scripts
                  pkg-manager: yarn
            - run:
                  command: yarn docs:prettier:check
                  name: Prettier
                  working_directory: scripts
    sandboxes:
        executor:
            class: small
            name: sb_node_22_classic
        steps:
            - run:
                  command: echo "Grouping sandboxes in CI graph"
                  name: Grouping sandboxes in CI graph
    react-vite-default-ts--create:
        description: react-vite/default-ts (create)
        executor:
            class: large
            name: sb_node_22_browsers
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Start Event Collector
                  working_directory: scripts
                  background: true
                  command: yarn jiti ./event-log-collector.ts
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
                      yarn wait-on tcp:127.0.0.1:6007
            - run:
                  name: Setup Corepack
                  command: |-
                      sudo corepack enable
                      which yarn
                      yarn --version
            - run:
                  name: Create Sandboxes
                  command: yarn task sandbox --template react-vite/default-ts --no-link -s sandbox --debug
                  environment:
                      STORYBOOK_TELEMETRY_DEBUG: 1
                      STORYBOOK_TELEMETRY_URL: http://127.0.0.1:6007/event-log
            - store_artifacts:
                  path: sandbox/react-vite-default-ts/debug-storybook.log
                  destination: logs
            - persist_to_workspace:
                  paths:
                      - sandbox/react-vite-default-ts
                  root: .
    react-vite-default-ts--build:
        description: react-vite/default-ts (build)
        executor:
            class: xlarge
            name: sb_playwright
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Build storybook
                  command: yarn task build --template react-vite/default-ts --no-link -s build
            - run:
                  name: Serve storybook
                  background: true
                  command: yarn task serve --template react-vite/default-ts --no-link -s serve
            - run:
                  name: Wait on storybook
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests --template react-vite/default-ts --no-link -s never" --verbose --index=0 --total=1
    react-vite-default-ts--dev:
        description: react-vite/default-ts (dev)
        executor:
            class: xlarge
            name: sb_playwright
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Run storybook
                  working_directory: code
                  background: true
                  command: yarn task dev --template react-vite/default-ts --no-link -s dev
            - run:
                  name: Wait on storybook
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:6006
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests-dev --template react-vite/default-ts --no-link -s never" --verbose --index=0 --total=1
    react-vite-default-js--create:
        description: react-vite/default-js (create)
        executor:
            class: large
            name: sb_node_22_browsers
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Verdaccio
                  working_directory: code
                  background: true
                  command: yarn local-registry --open
            - run:
                  name: Start Event Collector
                  working_directory: scripts
                  background: true
                  command: yarn jiti ./event-log-collector.ts
            - run:
                  name: Wait on servers
                  working_directory: code
                  command: |-
                      yarn wait-on tcp:127.0.0.1:6001
                      yarn wait-on tcp:127.0.0.1:6002
                      yarn wait-on tcp:127.0.0.1:6007
            - run:
                  name: Setup Corepack
                  command: |-
                      sudo corepack enable
                      which yarn
                      yarn --version
            - run:
                  name: Create Sandboxes
                  command: yarn task sandbox --template react-vite/default-js --no-link -s sandbox --debug
                  environment:
                      STORYBOOK_TELEMETRY_DEBUG: 1
                      STORYBOOK_TELEMETRY_URL: http://127.0.0.1:6007/event-log
            - store_artifacts:
                  path: sandbox/react-vite-default-js/debug-storybook.log
                  destination: logs
            - persist_to_workspace:
                  paths:
                      - sandbox/react-vite-default-js
                  root: .
    react-vite-default-js--build:
        description: react-vite/default-js (build)
        executor:
            class: xlarge
            name: sb_playwright
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Build storybook
                  command: yarn task build --template react-vite/default-js --no-link -s build
            - run:
                  name: Serve storybook
                  background: true
                  command: yarn task serve --template react-vite/default-js --no-link -s serve
            - run:
                  name: Wait on storybook
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:8001
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests --template react-vite/default-js --no-link -s never" --verbose --index=0 --total=1
    react-vite-default-js--dev:
        description: react-vite/default-js (dev)
        executor:
            class: xlarge
            name: sb_playwright
        steps:
            - git-shallow-clone/checkout_advanced:
                  clone_options: --depth 1
            - attach_workspace:
                  at: .
            - restore_cache:
                  keys: *a1
            - run:
                  name: Run storybook
                  working_directory: code
                  background: true
                  command: yarn task dev --template react-vite/default-js --no-link -s dev
            - run:
                  name: Wait on storybook
                  working_directory: code
                  command: yarn wait-on tcp:127.0.0.1:6006
            - run:
                  name: Running E2E Tests
                  command: |-
                      TEST_FILES=$(circleci tests glob "code/e2e-tests/*.{test,spec}.{ts,js,mjs}")
                      echo "$TEST_FILES" | circleci tests run --command="xargs yarn task e2e-tests-dev --template react-vite/default-js --no-link -s never" --verbose --index=0 --total=1
workflows:
    docs:
        jobs:
            - pretty-docs
            - build
            - check:
                  requires:
                      - build
            - sandboxes:
                  requires:
                      - build
            - react-vite-default-ts--create:
                  requires:
                      - sandboxes
            - react-vite-default-ts--build:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-ts--dev:
                  requires:
                      - react-vite-default-ts--create
            - react-vite-default-js--create:
                  requires:
                      - sandboxes
            - react-vite-default-js--build:
                  requires:
                      - react-vite-default-js--create
            - react-vite-default-js--dev:
                  requires:
                      - react-vite-default-js--create
        when:
            equal:
                - docs
                - << pipeline.parameters.workflow >>
