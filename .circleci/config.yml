version: 2.1
orbs:
  git-shallow-clone: guitarrapc/git-shallow-clone@2.5.0
  browser-tools: circleci/browser-tools@1.4.1
  node: circleci/node@5.2.0

executors:
  sb_node_22_browsers:
    working_directory: /tmp/storybook
    docker:
      - image: cimg/node:22.13.1-browsers
        environment:
          NODE_OPTIONS: --max_old_space_size=6144
    resource_class: medium

jobs:
  build:
    executor: sb_node_22_browsers
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile
          command: |
            yarn task compile -s auto --no-link --debug
      - run:
          name: Publish to Verdaccio
          command: yarn local-registry --publish
          working_directory: code
      - persist_to_workspace:
          root: .
          paths:
            - code
            - scripts
            - .verdaccio-cache
            - .yarn
      # creating a production build should not cause git pending changes
      - run:
          name: Check for pending changes
          command: |
            git diff --exit-code
            yarn dedupe --check
  lint:
    executor: sb_node_22_browsers
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile (non production)
          command: yarn task compile -s install
          working_directory: code
      - run:
          name: Lint
          command: yarn lint
          working_directory: code

  docs:
    executor: sb_node_22_browsers
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Docs Prettier Check
          command: yarn docs:prettier:check
          working_directory: scripts

  sandbox-test-react-vite-default-ts:
    executor: sb_node_22_browsers
    steps:
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Start Verdaccio (background)
          command: yarn local-registry --open
          working_directory: scripts
          background: true
      - run:
          name: Wait for Proxy (port 6001)
          command: yarn wait-on tcp:127.0.0.1:6001
          working_directory: scripts
      - run:
          name: Wait for Verdaccio (port 6002)
          command: yarn wait-on tcp:127.0.0.1:6002
          working_directory: scripts
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template react-vite/default-ts --no-link --start-from=sandbox --junit
      - run:
          name: Smoke Test
          command: yarn task smoke-test -s auto --template react-vite/default-ts
      - run:
          name: Test Runner
          command: yarn task test-runner -s auto --template react-vite/default-ts
      - run:
          name: Vitest Integration
          command: yarn task vitest-integration -s auto --template react-vite/default-ts
      - run:
          name: Chromatic
          command: yarn task chromatic -s auto --template react-vite/default-ts
      - run:
          name: E2E Tests
          command: yarn task e2e-tests -s auto --template react-vite/default-ts

  sandbox-test-angular-cli-default-ts:
    executor: sb_node_22_browsers
    steps:
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Start Verdaccio (background)
          command: yarn local-registry --open
          working_directory: scripts
          background: true
      - run:
          name: Wait for Proxy (port 6001)
          command: yarn wait-on tcp:127.0.0.1:6001
          working_directory: scripts
      - run:
          name: Wait for Verdaccio (port 6002)
          command: yarn wait-on tcp:127.0.0.1:6002
          working_directory: scripts
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template angular-cli/default-ts --no-link --start-from=sandbox --junit
      - run:
          name: Smoke Test
          command: yarn task smoke-test -s auto --template angular-cli/default-ts
      - run:
          name: Test Runner
          command: yarn task test-runner -s auto --template angular-cli/default-ts
      - run:
          name: Chromatic
          command: yarn task chromatic -s auto --template angular-cli/default-ts
      - run:
          name: E2E Tests
          command: yarn task e2e-tests -s auto --template angular-cli/default-ts

  sandbox-test-bench-react-vite-default-ts:
    executor: sb_node_22_browsers
    steps:
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Start Verdaccio (background)
          command: yarn local-registry --open
          working_directory: scripts
          background: true
      - run:
          name: Wait for Proxy (port 6001)
          command: yarn wait-on tcp:127.0.0.1:6001
          working_directory: scripts
      - run:
          name: Wait for Verdaccio (port 6002)
          command: yarn wait-on tcp:127.0.0.1:6002
          working_directory: scripts
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template bench/react-vite-default-ts --no-link --start-from=sandbox --junit
      # No event log checker or test steps for this bench template

workflows:
  version: 2
  normal:
    jobs:
      - build
      - lint
      - docs
      - sandbox-test-react-vite-default-ts:
          requires: [build]
      - sandbox-test-angular-cli-default-ts:
          requires: [build]
      - sandbox-test-bench-react-vite-default-ts:
          requires: [build]
