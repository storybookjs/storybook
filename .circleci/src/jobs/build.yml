executor:
  class: large
  name: sb_node_22_classic

steps:
  - git-shallow-clone/checkout_advanced:
      clone_options: '--depth 1 --verbose'
  - restore_cache:
      name: Restore Yarn cache
      keys:
        - build-yarn-2-cache-v5--{{ checksum "yarn.lock" }}
  - run:
      name: Compile
      command: |
        yarn task --task compile --start-from=auto --no-link --debug
        git diff --exit-code
        yarn dedupe --check
  - run:
      name: Publish to Verdaccio
      command: |
        yarn local-registry --publish
  - report-workflow-on-failure
  - store_artifacts:
      path: bench/esbuild-metafiles
  - save_cache:
      name: Save Yarn cache
      key: build-yarn-2-cache-v5--{{ checksum "yarn.lock" }}
      paths:
        - ~/.yarn/berry/cache
  - persist_to_workspace:
      root: .
      paths:
        - node_modules
        - addons
        - scripts/node_modules
        - bench
        - examples
        - frameworks
        - lib
        - core
        - builders
        - renderers
        - presets
        - .verdaccio-cache
