version: 2.1
orbs:
  git-shallow-clone: guitarrapc/git-shallow-clone@2.5.0
  browser-tools: circleci/browser-tools@1.4.1
  node: circleci/node@5.2.0

executors:
  sb_node_22_classic:
    parameters:
      resource-size:
        description: The Resource class
        type: enum
        enum: ["small", "medium", "medium+", "large", "xlarge"]
        default: "small"
    working_directory: /tmp/storybook
    docker:
      - image: cimg/node:22.13.1
        environment:
          NODE_OPTIONS: --max_old_space_size=6144
    resource_class: <<parameters.resource-size>>
  sb_node_22_browsers:
    parameters:
      resource-size:
        description: The Resource class
        type: enum
        enum: ["small", "medium", "medium+", "large", "xlarge"]
        default: "medium"
    working_directory: /tmp/storybook
    docker:
      - image: cimg/node:22.13.1-browsers
        environment:
          NODE_OPTIONS: --max_old_space_size=6144
    resource_class: <<parameters.resource-size>>
  sb_playwright:
    parameters:
      resource-size:
        description: The Resource class
        type: enum
        enum: ["small", "medium", "medium+", "large", "xlarge"]
        default: "medium"
    working_directory: /tmp/storybook
    docker:
      - image: mcr.microsoft.com/playwright:v1.48.1-jammy
        environment:
          NODE_OPTIONS: --max_old_space_size=6144
    resource_class: <<parameters.resource-size>>

jobs:
  build:
    executor:
      name: sb_node_22_classic
      resource-size: large
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile
          command: |
            yarn task compile -s auto --no-link --debug
      - run:
          name: Publish to Verdaccio
          command: yarn local-registry --publish
          working_directory: code
      - persist_to_workspace:
          root: .
          paths:
            - code
            - scripts
            - .verdaccio-cache
            - .yarn
            - node_modules
            - package.json
            - yarn.lock
            - .yarnrc.yml
            - prettier.config.mjs
            - .ignore
      # creating a production build should not cause git pending changes
      - run:
          name: Check for pending changes
          command: |
            git diff --exit-code
            yarn dedupe --check
  lint:
    executor:
      name: sb_node_22_classic
      resource-size: large
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile (non production)
          command: yarn task compile -s install
          working_directory: code
      - run:
          name: Lint:Package
          command: yarn lint:package
          working_directory: code
      - run:
          name: Lint:Other
          command: yarn lint:other
          working_directory: code
      - run:
          name: Lint:JS
          command: yarn lint:js
          working_directory: code
      # running linting should not cause git pending changes
      - run:
          name: Check for pending changes
          command: |
            git diff --exit-code
            yarn dedupe --check

  docs:
    executor:
      name: sb_node_22_classic
      resource-size: small
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Docs Prettier Check
          command: yarn docs:prettier:check
          working_directory: scripts

  sandbox-test:
    parameters:
      resource-size:
        description: The Resource size
        type: enum
        enum: ["small", "medium", "medium+", "large", "xlarge"]
        default: "medium"
      template_id:
        type: string
      feature-smoke_test:
        type: boolean
        default: true
      feature-test_runner:
        type: boolean
        default: true
      feature-vitest_integration:
        type: boolean
        default: true
      feature-chromatic:
        type: boolean
        default: true
      feature-e2e:
        type: boolean
        default: true
    executor:
      name: sb_playwright
      resource-size: << parameters.resource-size >>
    steps:
      - git-shallow-clone/checkout_advanced:
          clone_options: "--depth 1 --verbose"
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Setup Corepack
          command: corepack enable
      - run:
          name: Verify corepack & yarn install
          command: |
            which yarn
            yarn --version
      - run:
          name: Start Verdaccio (background)
          command: yarn local-registry --open
          working_directory: scripts
          background: true
      - run:
          name: Wait for Proxy (port 6001)
          command: yarn wait-on tcp:127.0.0.1:6001
          working_directory: scripts
      - run:
          name: Wait for Verdaccio (port 6002)
          command: yarn wait-on tcp:127.0.0.1:6002
          working_directory: scripts
      - run:
          name: Create Sandbox
          command: yarn task sandbox -s auto --no-link --junit --template << parameters.template_id >>
      - run:
          name: Build static storybook
          command: yarn task build -s auto --no-link --junit --template << parameters.template_id >>
      - when:
          condition: << parameters.feature-smoke_test >>
          steps:
            - run:
                name: Smoke Test
                command: yarn task smoke-test -s auto --no-link --junit --template << parameters.template_id >>
      - when:
          condition: << parameters.feature-test_runner >>
          steps:
            - run:
                name: Test Runner
                command: yarn task test-runner -s auto --no-link --junit --template << parameters.template_id >>
      - when:
          condition: << parameters.feature-vitest_integration >>
          steps:
            - run:
                name: Vitest Integration
                command: yarn task vitest-integration -s auto --no-link --junit --template << parameters.template_id >>
      - when:
          condition: << parameters.feature-chromatic >>
          steps:
            - run:
                name: Chromatic
                command: yarn task chromatic -s auto --no-link --junit --template << parameters.template_id >>
      - when:
          condition: << parameters.feature-e2e >>
          steps:
            - run:
                name: E2E Tests
                command: yarn task e2e-tests -s auto --no-link --junit --template << parameters.template_id >>

workflows:
  normal:
    jobs:
      - build
      - lint
      - docs
      - sandbox-test:
          name: React Vite (TS)
          requires: [build]
          resource-size: large
          template_id: react-vite/default-ts
          feature-smoke_test: true
          feature-test_runner: true
          feature-vitest_integration: true
          feature-chromatic: true
          feature-e2e: true
      - sandbox-test:
          name: Angular CLI (TS)
          requires: [build]
          resource-size: xlarge
          template_id: angular-cli/default-ts
          feature-smoke_test: true
          feature-test_runner: true
          feature-vitest_integration: false
          feature-chromatic: true
          feature-e2e: true
      - sandbox-test:
          name: Bench (React Vite)
          requires: [build]
          resource-size: medium
          template_id: bench/react-vite-default-ts
          feature-smoke_test: true
          feature-test_runner: false
          feature-vitest_integration: false
          feature-chromatic: false
          feature-e2e: false
