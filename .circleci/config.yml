version: 2.1
orbs:
  checkout: circleci/checkout@4

executors:
  sb_node_22_browsers:
    working_directory: /tmp/storybook
    docker:
      - image: cimg/node:22.13.1-browsers
        environment:
          NODE_OPTIONS: --max_old_space_size=6144
    resource_class: medium

jobs:
  build:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile
          command: |
            yarn task compile -s auto --no-link --debug
      - run:
          name: Check for pending changes
          command: |
            git diff --exit-code
            yarn dedupe --check
      - persist_to_workspace:
          root: .
          paths:
            - code
            - scripts
            - .verdaccio-cache
  lint:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Install dependencies (code)
          command: yarn install --frozen-lockfile
          working_directory: code
      - run:
          name: Compile (for lint)
          command: yarn task compile
          working_directory: code
      - run:
          name: Lint
          command: yarn lint
          working_directory: code

  docs:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - run:
          name: Install dependencies (scripts)
          command: yarn install --frozen-lockfile
          working_directory: scripts
      - run:
          name: Docs Prettier Check
          command: yarn docs:prettier:check
          working_directory: scripts

  sandbox-test-react-vite-default-ts:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template react-vite/default-ts --no-link --start-from=sandbox --junit
      - run:
          name: Smoke Test
          command: yarn task smoke-test -s auto --template react-vite/default-ts
      - run:
          name: Test Runner
          command: yarn task test-runner -s auto --template react-vite/default-ts
      - run:
          name: Vitest Integration
          command: yarn task vitest-integration -s auto --template react-vite/default-ts
      - run:
          name: Chromatic
          command: yarn task chromatic -s auto --template react-vite/default-ts
      - run:
          name: E2E Tests
          command: yarn task e2e-tests -s auto --template react-vite/default-ts

  sandbox-test-angular-cli-default-ts:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template angular-cli/default-ts --no-link --start-from=sandbox --junit
      - run:
          name: Smoke Test
          command: yarn task smoke-test -s auto --template angular-cli/default-ts
      - run:
          name: Test Runner
          command: yarn task test-runner -s auto --template angular-cli/default-ts
      - run:
          name: Chromatic
          command: yarn task chromatic -s auto --template angular-cli/default-ts
      - run:
          name: E2E Tests
          command: yarn task e2e-tests -s auto --template angular-cli/default-ts

  sandbox-test-bench-react-vite-default-ts:
    executor: sb_node_22_browsers
    steps:
      - checkout/checkout:
          fetch-depth: 1
      - attach_workspace:
          at: /tmp/storybook
      - run:
          name: Build Sandbox
          command: |
            yarn task build -s auto --template bench/react-vite-default-ts --no-link --start-from=sandbox --junit
      # No event log checker or test steps for this bench template

workflows:
  version: 2
  normal:
    jobs:
      - build
      - lint
      - docs
      - sandbox-test-react-vite-default-ts:
          requires: [build]
      - sandbox-test-angular-cli-default-ts:
          requires: [build]
      - sandbox-test-bench-react-vite-default-ts:
          requires: [build]
