name: Trigger CircleCI workflow

on:
  # Use pull_request_target, as we don't need to check out the actual code of the fork in this script.
  # And this is the only way to trigger the Circle CI API on forks as well.
  pull_request_target:
    types: [opened, synchronize, labeled, reopened]
  push:
    # branches:
    #   - next
    #   - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  get-branch:
    if: github.repository_owner == 'storybookjs'
    runs-on: ubuntu-latest
    steps:
      - id: get-branch
        env:
          # Stored as environment variable to prevent script injection
          REF_NAME: ${{ github.ref_name }}
          PR_REF_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          if [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            export BRANCH=pull/${{ github.event.pull_request.number }}/head
          elif [ "${{ github.event_name }}" = "push" ]; then
            export BRANCH="$REF_NAME"
          else
            export BRANCH="$PR_REF_NAME"
          fi
          echo "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_ENV
    outputs:
      branch: ${{ env.branch }}

  get-parameters:
    if: github.repository_owner == 'storybookjs'
    runs-on: ubuntu-latest
    steps:
      - name: Determine workflow from labeled event
        if: github.event_name == 'pull_request_target' && github.event.action == 'labeled'
        run: |
          echo "PR Labeled event detected with label: ${{ github.event.label.name }}"
          case "${{ github.event.label.name }}" in
            ci:normal) echo "workflow=normal" >> $GITHUB_ENV ;;
            ci:docs)   echo "workflow=docs" >> $GITHUB_ENV ;;
            ci:merged) echo "workflow=merged" >> $GITHUB_ENV ;;
            ci:daily)  echo "workflow=daily" >> $GITHUB_ENV ;;
            *)
              echo "Label '${{ github.event.label.name }}' is not a ci: label â€” leaving workflow empty"
              ;;
          esac

      - name: Determine workflow from push events based on existing labels
        if: github.event_name == 'push'
        run: |
          echo "Resolving PR number for ref: ${{ github.ref_name }}"
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number' 2>/dev/null || echo "")
          echo "Found PR number: $PR_NUMBER"

          # If PR number not found, try alternative methods
          if [ -z "$PR_NUMBER" ]; then
            echo "Trying alternative PR detection methods..."
            # Try to find PR by checking recent PRs that might be associated with this branch
            PR_NUMBER=$(gh pr list --state open --json number,headRefName -q ".[] | select(.headRefName == \"${{ github.ref_name }}\") | .number" 2>/dev/null || echo "")
            echo "Alternative PR search found: $PR_NUMBER"
          fi

          if [ -n "$PR_NUMBER" ]; then
            echo "Fetching labels for PR #$PR_NUMBER"
            LABELS=$(gh pr view "$PR_NUMBER" --json labels -q ".labels[].name" 2>/dev/null || echo "")
            echo "Fetched labels: $LABELS"
          else
            echo "No PR found for ref: ${{ github.ref_name }}; no labels detected."
            LABELS=""
          fi
          echo "Detected PR labels: $LABELS"

          WORKFLOW=""
          if echo "$LABELS" | grep -q "ci:merged"; then
            WORKFLOW="merged"
          elif echo "$LABELS" | grep -q "ci:normal"; then
            WORKFLOW="normal"
          elif echo "$LABELS" | grep -q "ci:docs"; then
            WORKFLOW="docs"
          elif echo "$LABELS" | grep -q "ci:daily"; then
            WORKFLOW="daily"
          fi

          if [ -n "$WORKFLOW" ]; then
            echo "Workflow detected: $WORKFLOW"
            echo "workflow=$WORKFLOW" >> $GITHUB_ENV
          else
            echo "No ci:* label found in PR labels. Skipping CI trigger."
          fi
    outputs:
      workflow: ${{ env.workflow }}
      ghBaseBranch: ${{ github.event.pull_request.base.ref || github.ref_name }}
      ghPrNumber: ${{ github.event.pull_request.number || '' }}

  trigger-circle-ci-workflow:
    runs-on: ubuntu-latest
    needs: [get-branch, get-parameters]
    if: github.repository_owner == 'storybookjs' && needs.get-parameters.outputs.workflow != ''
    steps:
      - name: Trigger CircleCI workflow
        uses: fjogeleit/http-request-action@v1
        with:
          url: "https://circleci.com/api/v2/project/gh/storybookjs/storybook/pipeline"
          method: "POST"
          customHeaders: '{"Content-Type": "application/json", "Circle-Token": "${{ secrets.CIRCLE_CI_TOKEN }}"}'
          data: '{ "branch": "${{needs.get-branch.outputs.branch}}", "parameters": ${{toJson(needs.get-parameters.outputs)}} }'
